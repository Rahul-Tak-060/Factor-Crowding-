# System Architecture Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         FACTOR CROWDING ANALYSIS SYSTEM                     │
│                         Crash Risk Prediction Pipeline                      │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ 1. DATA ACQUISITION (data/download.py)                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Internet Sources                                                           │
│  ┌───────────────┐   ┌──────────────┐   ┌─────────────────┐              │
│  │ Ken French    │   │ FRED API     │   │ Yahoo Finance   │              │
│  │ Data Library  │   │ (VIX)        │   │ (ETF Data)      │              │
│  └───────┬───────┘   └──────┬───────┘   └────────┬────────┘              │
│          │                  │                     │                        │
│          ▼                  ▼                     ▼                        │
│  ┌──────────────────────────────────────────────────────┐                 │
│  │         DataDownloader Class                          │                 │
│  │  • _download_ff_zip() - Parse Fama-French data       │                 │
│  │  • download_vix() - Fetch VIX from FRED              │                 │
│  │  • download_etf_data() - Get ETF prices/volumes      │                 │
│  └──────────────────────────────────────────────────────┘                 │
│          │                  │                     │                        │
│          ▼                  ▼                     ▼                        │
│  ┌──────────────┐   ┌──────────────┐   ┌──────────────────┐              │
│  │ ff_daily_    │   │ vix_daily.   │   │ MTUM_daily.csv   │              │
│  │ factors.csv  │   │ csv          │   │ VLUE_daily.csv   │              │
│  │ (26K rows)   │   │ (3.4K rows)  │   │ USMV_daily.csv   │              │
│  └──────────────┘   └──────────────┘   └──────────────────┘              │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                  │
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ 2. DATA CLEANING & ALIGNMENT (data/clean.py)                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌──────────────────────────────────────────────────────┐                 │
│  │         DataCleaner Class                             │                 │
│  │  • align_calendars() - Synchronize dates              │                 │
│  │  • compute_returns() - Price → Return conversion      │                 │
│  │  • create_master_dataset() - Merge all sources        │                 │
│  └──────────────────────────────────────────────────────┘                 │
│                                                                             │
│  Input: 4 datasets with different calendars                                │
│  ┌────────────┬────────────┬────────────┬────────────┐                    │
│  │ FF Factors │ VIX Data   │ MTUM ETF   │ VLUE ETF   │                    │
│  │ 26,129 days│ 3,403 days │ 3,208 days │ 3,208 days │                    │
│  └────────────┴────────────┴────────────┴────────────┘                    │
│                       │                                                     │
│                       ▼ align_calendars(method='inner')                    │
│                       │                                                     │
│  Output: Aligned master dataset                                            │
│  ┌──────────────────────────────────────────────────────────┐             │
│  │ master_dataset.csv                                        │             │
│  │ • 3,174 rows (common trading days)                        │             │
│  │ • 12 columns: Mkt-RF, SMB, HML, Mom, VIX, ETF data       │             │
│  │ • Date range: 2013-04-19 to 2024-12-31                   │             │
│  └──────────────────────────────────────────────────────────┘             │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                  │
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ 3. CROWDING INDEX CONSTRUCTION (features/crowding.py)                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌──────────────────────────────────────────────────────┐                 │
│  │    CrowdingIndexBuilder Class                         │                 │
│  │  • compute_zscore() - Normalize signals               │                 │
│  │  • build_flow_attention_proxy() - ETF activity        │                 │
│  │  • build_comovement_proxy() - Factor correlations     │                 │
│  │  • build_factor_side_proxy() - Factor characteristics │                 │
│  │  • build_composite_index() - Combine all signals      │                 │
│  └──────────────────────────────────────────────────────┘                 │
│                                                                             │
│  Three Crowding Proxies:                                                   │
│  ┌─────────────────┐  ┌──────────────────┐  ┌─────────────────────┐      │
│  │ Flow-Attention  │  │ Co-Movement      │  │ Factor-Side         │      │
│  │ (9 signals)     │  │ (4 signals)      │  │ (8 signals)         │      │
│  │                 │  │                  │  │                     │      │
│  │ • ETF volumes   │  │ • Factor corr.   │  │ • Factor volatility │      │
│  │ • ETF returns   │  │ • Return disp.   │  │ • VIX levels        │      │
│  │ • Return vol.   │  │ • Cross-sect.    │  │ • Dispersion        │      │
│  └────────┬────────┘  └─────────┬────────┘  └──────────┬──────────┘      │
│           │                     │                       │                  │
│           └─────────────────────┴───────────────────────┘                  │
│                                 │                                           │
│                                 ▼ Equal-weighted average                   │
│                                 │                                           │
│                    ┌────────────────────────┐                              │
│                    │ Composite Crowding     │                              │
│                    │ Index (24 signals)     │                              │
│                    │                        │                              │
│                    │ Range: -2.2 to +2.6    │                              │
│                    │ Mean: 0.16, Std: 0.40  │                              │
│                    └────────────────────────┘                              │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                  │
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ 4. DRAWDOWN & CRASH ANALYSIS (analysis/drawdowns.py)                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌──────────────────────────────────────────────────────┐                 │
│  │    DrawdownAnalyzer Class                             │                 │
│  │  • compute_drawdown() - Calculate DD from returns     │                 │
│  │  • identify_crash_events() - Detect extreme days      │                 │
│  │  • compute_drawdown_episodes() - Group crashes        │                 │
│  └──────────────────────────────────────────────────────┘                 │
│                                                                             │
│  For each factor: Mkt-RF, SMB, HML, Mom                                    │
│  ┌─────────────────────────────────────────────────┐                       │
│  │ Drawdown Metrics:                               │                       │
│  │ • Daily drawdown series (distance from peak)    │                       │
│  │ • Crash flags (1% threshold)                    │                       │
│  │ • Crash episodes with start/end dates           │                       │
│  │                                                  │                       │
│  │ Example: Momentum Factor                        │                       │
│  │ • 30 crash days (1.02% of all days)             │                       │
│  │ • 8 major drawdown episodes                     │                       │
│  │ • Worst: -14.37% on 2020-03-20 (COVID)          │                       │
│  └─────────────────────────────────────────────────┘                       │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                  │
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ 5. PREDICTIVE MODELING (models/predict.py)                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌──────────────────────────────────────────────────────┐                 │
│  │    CrashPredictor Class                               │                 │
│  │  • prepare_predictive_dataset() - Feature engineer    │                 │
│  │  • fit_logistic_model() - Train classifier            │                 │
│  │  • analyze_forward_returns() - Conditional analysis   │                 │
│  └──────────────────────────────────────────────────────┘                 │
│                                                                             │
│  Feature Engineering:                                                       │
│  ┌────────────────────────────────────────────────┐                        │
│  │ X (Predictors):                                │                        │
│  │ • Crowding index (main predictor)              │                        │
│  │ • VIX level                                    │                        │
│  │ • High stress indicator (VIX > 75%)            │                        │
│  │ • Recent momentum volatility (20-day)          │                        │
│  │ • Recent momentum returns (20-day)             │                        │
│  │ • Recent market returns (20-day)               │                        │
│  │ • Crowding × Stress interaction                │                        │
│  │                                                 │                        │
│  │ Y (Target):                                     │                        │
│  │ • Crash in next 5 days? (Binary: 0/1)          │                        │
│  └────────────────────────────────────────────────┘                        │
│                    │                                                        │
│                    ▼ Train/Test Split (80/20)                              │
│                    │                                                        │
│  ┌────────────────────────────────────────────────┐                        │
│  │ Logistic Regression Model                      │                        │
│  │                                                 │                        │
│  │ Training Results:                               │                        │
│  │ • Train AUC: 0.90                               │                        │
│  │ • Test AUC: 0.88 (excellent!)                   │                        │
│  │                                                 │                        │
│  │ Key Coefficients:                               │                        │
│  │ • Crowding: +0.60 (✓ confirms hypothesis)      │                        │
│  │ • Recent market gains: +5.28                    │                        │
│  │ • Momentum volatility: +0.93                    │                        │
│  │ • High stress: -1.41 (counterintuitive!)        │                        │
│  │ • Crowding × Stress: -1.02                      │                        │
│  └────────────────────────────────────────────────┘                        │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                  │
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ 6. VISUALIZATION & REPORTING (report/figures.py)                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌──────────────────────────────────────────────────────┐                 │
│  │    FigureGenerator Class                              │                 │
│  │  • plot_crowding_timeseries() - Crowding evolution    │                 │
│  │  • plot_drawdown_episodes() - Major crashes           │                 │
│  │  • plot_roc_curve() - Model performance               │                 │
│  │  • plot_model_coefficients() - Feature importance     │                 │
│  │  • plot_conditional_returns() - Returns by crowding   │                 │
│  │  • plot_correlation_heatmap() - Variable relationships│                 │
│  └──────────────────────────────────────────────────────┘                 │
│                                                                             │
│  7 Publication-Quality Figures:                                            │
│  ┌───────────────────────────────────────────────────────────┐            │
│  │ 1. crowding_index_timeseries.png (428 KB)                 │            │
│  │    → 11 years of crowding evolution                       │            │
│  │                                                            │            │
│  │ 2. top_drawdown_episodes.png (91 KB)                      │            │
│  │    → Major crash periods for each factor                  │            │
│  │                                                            │            │
│  │ 3. roc_curve.png (128 KB)                                 │            │
│  │    → Model discrimination ability (AUC = 0.88)            │            │
│  │                                                            │            │
│  │ 4. model_coefficients.png (90 KB)                         │            │
│  │    → What drives crashes (feature importance)             │            │
│  │                                                            │            │
│  │ 5. conditional_returns_5d.png (82 KB)                     │            │
│  │    → 5-day returns by crowding decile                     │            │
│  │                                                            │            │
│  │ 6. conditional_returns_20d.png (84 KB)                    │            │
│  │    → 20-day returns by crowding decile                    │            │
│  │                                                            │            │
│  │ 7. correlation_heatmap.png (130 KB)                       │            │
│  │    → Relationships between all variables                  │            │
│  └───────────────────────────────────────────────────────────┘            │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ COMMAND-LINE INTERFACE (cli.py)                                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  User Commands:                                                             │
│  ┌──────────────────────────────────────────────────┐                      │
│  │ $ factor-crowding download [--start] [--force]   │                      │
│  │   → Runs step 1 only                             │                      │
│  │                                                   │                      │
│  │ $ factor-crowding clean [--start] [--end]        │                      │
│  │   → Runs steps 1-2                               │                      │
│  │                                                   │                      │
│  │ $ factor-crowding run [--start] [--end]          │                      │
│  │   → Runs complete pipeline (steps 1-6)           │                      │
│  │                                                   │                      │
│  │ $ factor-crowding info                           │                      │
│  │   → Shows configuration and project info         │                      │
│  └──────────────────────────────────────────────────┘                      │
│                                                                             │
│  Pipeline Orchestration (run command):                                      │
│  Step 1: Download → Step 2: Clean → Step 3: Crowding →                     │
│  Step 4: Drawdowns → Step 5: Models → Step 6: Figures                      │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ KEY FINDINGS & OUTPUT                                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ✓ Crowding is measurable from 24 market signals                           │
│  ✓ Crowding predicts crashes with 88% accuracy (AUC)                       │
│  ✓ Momentum factor most vulnerable (8 crash episodes)                      │
│  ✓ Hidden risk (low VIX + high crowding) most dangerous                    │
│  ✓ High crowding increases volatility & tail risk                          │
│                                                                             │
│  13 Processed Datasets + 7 Figures + Model Diagnostics                     │
│  Ready for publication and further research                                │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

Legend:
  ┌───┐ = Data/File
  │   │ = Process/Class
  ───→ = Data flow
  • = Feature/Method
```
